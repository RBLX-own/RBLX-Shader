--// ULTRA MODERN ENHANCER SCRIPT v3.0
--// Complete Storage System, Modern UI, Advanced Features

local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")
local SoundService = game:GetService("SoundService")
local ContentProvider = game:GetService("ContentProvider")
local ReplicatedStorage = game:GetService("ReplicatedStorage")

-- Wait for player
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Main GUI container
local gui = Instance.new("ScreenGui")
gui.Name = "UltraEnhancerGUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.DisplayOrder = 999
gui.Parent = playerGui

----------------------------------------------------
-- ADVANCED STORAGE SYSTEM WITH AUTO-SYNC
----------------------------------------------------
local UltraStorage = {
	Version = "3.0",
	Settings = {
		popupShown = false,
		telegramClicked = false,
		shaderEnabled = false,
		performanceMode = false,
		iconPosition = {X = 0.03, Y = 0.03},
		windowPosition = {X = 0.5, Y = 0.5},
		volume = 0.5,
		theme = "dark",
		animations = true,
		autoStart = true,
		notifications = true,
		lastUpdate = os.time()
	},
	
	Stats = {
		totalClicks = 0,
		totalUptime = 0,
		lastSession = 0,
		favoriteFeature = "shader"
	},
	
	Cache = {
		images = {},
		sounds = {},
		icons = {}
	}
}

-- Enhanced DataStore with backup system
local DataStoreService = game:GetService("DataStoreService")
local settingsStore = DataStoreService:GetDataStore("UltraEnhancer_Settings")
local statsStore = DataStoreService:GetDataStore("UltraEnhancer_Stats")

local function SaveAllData()
	local success, errorMsg = pcall(function()
		-- Save to DataStore
		settingsStore:SetAsync(tostring(player.UserId) .. "_settings", UltraStorage.Settings)
		statsStore:SetAsync(tostring(player.UserId) .. "_stats", UltraStorage.Stats)
		
		-- Update timestamp
		UltraStorage.Settings.lastUpdate = os.time()
		
		-- Local backup
		_G.UltraEnhancer_Backup = {
			settings = UltraStorage.Settings,
			stats = UltraStorage.Stats,
			timestamp = os.time()
		}
		
		-- Fire saved event
		if UltraStorage.Events and UltraStorage.Events.DataSaved then
			UltraStorage.Events.DataSaved:Fire()
		end
	end)
	
	if not success then
		warn("DataStore save failed:", errorMsg)
		-- Create comprehensive local backup
		_G.UltraEnhancer_LocalBackup = {
			settings = UltraStorage.Settings,
			stats = UltraStorage.Stats,
			cache = UltraStorage.Cache,
			timestamp = os.time()
		}
	end
	
	-- Auto-sync to cloud if available
	if _G.Synapse and _G.Synapse.serialize then
		pcall(function()
			writefile("UltraEnhancer_Backup.json", HttpService:JSONEncode(UltraStorage))
		end)
	end
end

local function LoadAllData()
	-- Try DataStore first
	local success1, settingsData = pcall(function()
		return settingsStore:GetAsync(tostring(player.UserId) .. "_settings")
	end)
	
	local success2, statsData = pcall(function()
		return statsStore:GetAsync(tostring(player.UserId) .. "_stats")
	end)
	
	if success1 and settingsData then
		UltraStorage.Settings = settingsData
	end
	
	if success2 and statsData then
		UltraStorage.Stats = statsData
	end
	
	-- Load from local backup if DataStore failed
	if not success1 and _G.UltraEnhancer_Backup then
		UltraStorage.Settings = _G.UltraEnhancer_Backup.settings or UltraStorage.Settings
		UltraStorage.Stats = _G.UltraEnhancer_Backup.stats or UltraStorage.Stats
	end
	
	-- Ensure all required fields exist
	UltraStorage.Settings.iconPosition = UltraStorage.Settings.iconPosition or {X = 0.03, Y = 0.03}
	UltraStorage.Settings.windowPosition = UltraStorage.Settings.windowPosition or {X = 0.5, Y = 0.5}
	UltraStorage.Settings.volume = UltraStorage.Settings.volume or 0.5
	UltraStorage.Settings.theme = UltraStorage.Settings.theme or "dark"
	UltraStorage.Settings.animations = UltraStorage.Settings.animations ~= false
	UltraStorage.Settings.autoStart = UltraStorage.Settings.autoStart ~= false
	UltraStorage.Settings.notifications = UltraStorage.Settings.notifications ~= false
	
	-- Update session stats
	UltraStorage.Stats.lastSession = os.time()
	
	print("ðŸ“Š Ultra Enhancer v3.0 - Data Loaded")
	print("   Theme:", UltraStorage.Settings.theme)
	print("   Animations:", UltraStorage.Settings.animations)
	print("   Auto Start:", UltraStorage.Settings.autoStart)
end

-- Auto-save every 30 seconds
task.spawn(function()
	while true do
		task.wait(30)
		SaveAllData()
	end
end)

----------------------------------------------------
-- EVENT SYSTEM FOR MODERN UI
----------------------------------------------------
UltraStorage.Events = {
	IconClicked = Instance.new("BindableEvent"),
	GUIOpened = Instance.new("BindableEvent"),
	GUIClosed = Instance.new("BindableEvent"),
	FeatureToggled = Instance.new("BindableEvent"),
	DataSaved = Instance.new("BindableEvent"),
	Notification = Instance.new("BindableEvent")
}

----------------------------------------------------
-- ASSET LOADER WITH CACHE
----------------------------------------------------
local AssetLoader = {
	ImageCache = {},
	SoundCache = {},
	
	LoadImage = function(id)
		if AssetLoader.ImageCache[id] then
			return AssetLoader.ImageCache[id]
		end
		
		local success, result = pcall(function()
			return "rbxassetid://" .. id
		end)
		
		if success then
			AssetLoader.ImageCache[id] = result
			return result
		end
		
		return "rbxassetid://6962520787" -- Default icon
	end,
	
	LoadSound = function(id)
		if AssetLoader.SoundCache[id] then
			return AssetLoader.SoundCache[id]
		end
		
		local sound = Instance.new("Sound")
		sound.SoundId = "rbxassetid://" .. id
		AssetLoader.SoundCache[id] = sound
		return sound
	end
}

-- Preload essential assets
local essentialAssets = {
	"6962520787", -- Default icon
	"5555108487", -- Shadow
	"8997378083", -- Gradient
	"8757247785"  -- Background
}

for _, assetId in pairs(essentialAssets) do
	task.spawn(function()
		AssetLoader.LoadImage(assetId)
	end)
end

----------------------------------------------------
-- MODERN NOTIFICATION SYSTEM
----------------------------------------------------
local NotificationManager = {
	Queue = {},
	Active = {},
	MaxNotifications = 3
}

function NotificationManager:Show(title, message, duration, type)
	duration = duration or 3
	type = type or "info"
	
	local notification = {
		Title = title,
		Message = message,
		Duration = duration,
		Type = type,
		Timestamp = os.time()
	}
	
	table.insert(self.Queue, notification)
	self:ProcessQueue()
	
	-- Fire event
	UltraStorage.Events.Notification:Fire(notification)
end

function NotificationManager:ProcessQueue()
	if #self.Active >= self.MaxNotifications then
		return
	end
	
	if #self.Queue > 0 then
		local notif = table.remove(self.Queue, 1)
		table.insert(self.Active, notif)
		self:CreateVisual(notif)
	end
end

function NotificationManager:CreateVisual(notification)
	-- Create notification frame
	local frame = Instance.new("Frame")
	frame.Size = UDim2.new(0, 300, 0, 80)
	frame.Position = UDim2.new(1, -320, 1, -100 - (#self.Active * 90))
	frame.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
	frame.BorderSizePixel = 0
	frame.ZIndex = 1000
	
	local uiCorner = Instance.new("UICorner", frame)
	uiCorner.CornerRadius = UDim.new(0, 12)
	
	local uiStroke = Instance.new("UIStroke", frame)
	uiStroke.Color = Color3.fromRGB(60, 60, 80)
	uiStroke.Thickness = 2
	
	-- Type indicator
	local indicator = Instance.new("Frame", frame)
	indicator.Size = UDim2.new(0, 4, 1, -20)
	indicator.Position = UDim2.new(0, 8, 0, 10)
	indicator.BackgroundColor3 = self:GetColorForType(notification.Type)
	indicator.BorderSizePixel = 0
	
	local indicatorCorner = Instance.new("UICorner", indicator)
	indicatorCorner.CornerRadius = UDim.new(1, 0)
	
	-- Title
	local title = Instance.new("TextLabel", frame)
	title.Size = UDim2.new(1, -40, 0, 30)
	title.Position = UDim2.new(0, 20, 0, 10)
	title.Text = notification.Title
	title.Font = Enum.Font.GothamBold
	title.TextSize = 16
	title.TextColor3 = Color3.fromRGB(255, 255, 255)
	title.BackgroundTransparency = 1
	title.TextXAlignment = Enum.TextXAlignment.Left
	
	-- Message
	local message = Instance.new("TextLabel", frame)
	message.Size = UDim2.new(1, -40, 0, 40)
	message.Position = UDim2.new(0, 20, 0, 40)
	message.Text = notification.Message
	message.Font = Enum.Font.Gotham
	message.TextSize = 14
	message.TextColor3 = Color3.fromRGB(200, 200, 220)
	message.BackgroundTransparency = 1
	message.TextXAlignment = Enum.TextXAlignment.Left
	message.TextWrapped = true
	
	frame.Parent = gui
	
	-- Animate in
	frame.Position = UDim2.new(1, 300, frame.Position.Y.Scale, frame.Position.Y.Offset)
	frame:TweenPosition(
		UDim2.new(1, -320, frame.Position.Y.Scale, frame.Position.Y.Offset),
		Enum.EasingDirection.Out,
		Enum.EasingStyle.Quad,
		0.3
	)
	
	-- Auto remove
	task.delay(notification.Duration, function()
		if frame and frame.Parent then
			frame:TweenPosition(
				UDim2.new(1, 300, frame.Position.Y.Scale, frame.Position.Y.Offset),
				Enum.EasingDirection.In,
				Enum.EasingStyle.Quad,
				0.3
			)
			task.wait(0.3)
			frame:Destroy()
			
			-- Remove from active
			for i, active in ipairs(self.Active) do
				if active == notification then
					table.remove(self.Active, i)
					break
				end
			end
			
			self:ProcessQueue()
		end
	end)
end

function NotificationManager:GetColorForType(type)
	local colors = {
		info = Color3.fromRGB(66, 135, 245),
		success = Color3.fromRGB(46, 204, 113),
		warning = Color3.fromRGB(241, 196, 15),
		error = Color3.fromRGB(231, 76, 60)
	}
	return colors[type] or colors.info
end

----------------------------------------------------
-- ULTRA MODERN MOVABLE ICON (FIXED CLICK)
----------------------------------------------------
local movableIcon = nil
local iconDragging = false
local dragStartPosition = nil
local iconStartPosition = nil
local iconLastClick = 0

local function CreateUltraIcon()
	-- Remove existing icon
	if movableIcon and movableIcon.Parent then
		movableIcon:Destroy()
	end
	
	-- Create main icon button
	movableIcon = Instance.new("ImageButton")
	movableIcon.Name = "UltraIcon"
	movableIcon.Size = UDim2.new(0, 80, 0, 80)
	movableIcon.AnchorPoint = Vector2.new(0.5, 0.5)
	movableIcon.AutoButtonColor = false
	movableIcon.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
	movableIcon.BackgroundTransparency = 0.15
	
	-- Load saved position
	local savedPos = UltraStorage.Settings.iconPosition
	movableIcon.Position = UDim2.new(
		savedPos and savedPos.X or 0.03,
		0,
		savedPos and savedPos.Y or 0.03,
		0
	)
	
	-- Ultra modern squircle design
	local uiCorner = Instance.new("UICorner", movableIcon)
	uiCorner.CornerRadius = UDim.new(0.35, 0) -- Very rounded squircle
	
	-- Glossy border
	local border = Instance.new("UIStroke", movableIcon)
	border.Color = Color3.fromRGB(100, 150, 255)
	border.Thickness = 3
	border.Transparency = 0.2
	border.ApplyStrokeMode = Enum.ApplyStrokeMode.Border
	
	-- Inner glow effect
	local innerGlow = Instance.new("Frame", movableIcon)
	innerGlow.Size = UDim2.new(1, -10, 1, -10)
	innerGlow.Position = UDim2.new(0, 5, 0, 5)
	innerGlow.BackgroundColor3 = Color3.fromRGB(255, 255, 255)
	innerGlow.BackgroundTransparency = 0.95
	innerGlow.BorderSizePixel = 0
	
	local glowCorner = Instance.new("UICorner", innerGlow)
	glowCorner.CornerRadius = UDim.new(0.3, 0)
	
	-- Icon content
	local iconContent = Instance.new("Frame", movableIcon)
	iconContent.Size = UDim2.new(0.7, 0, 0.7, 0)
	iconContent.Position = UDim2.new(0.15, 0, 0.15, 0)
	iconContent.BackgroundTransparency = 1
	
	-- Animated gradient
	local gradient = Instance.new("UIGradient", iconContent)
	gradient.Color = ColorSequence.new({
		ColorSequenceKeypoint.new(0, Color3.fromRGB(100, 200, 255)),
		ColorSequenceKeypoint.new(0.5, Color3.fromRGB(200, 100, 255)),
		ColorSequenceKeypoint.new(1, Color3.fromRGB(100, 200, 255))
	})
	gradient.Rotation = 45
	
	-- Rotating animation for gradient
	task.spawn(function()
		while movableIcon and movableIcon.Parent do
			gradient.Rotation = gradient.Rotation + 0.5
			if gradient.Rotation >= 360 then
				gradient.Rotation = 0
			end
			task.wait(0.05)
		end
	end)
	
	-- Icon symbol with glow
	local iconSymbol = Instance.new("TextLabel", iconContent)
	iconSymbol.Size = UDim2.new(1, 0, 1, 0)
	iconSymbol.Text = "âš¡"
	iconSymbol.Font = Enum.Font.GothamBold
	iconSymbol.TextSize = 36
	iconSymbol.TextColor3 = Color3.fromRGB(255, 255, 255)
	iconSymbol.BackgroundTransparency = 1
	iconSymbol.TextTransparency = 0.1
	
	-- Add text shadow for glow effect
	local textShadow = Instance.new("TextLabel", iconContent)
	textShadow.Size = UDim2.new(1, 0, 1, 0)
	textShadow.Text = "âš¡"
	textShadow.Font = Enum.Font.GothamBold
	textShadow.TextSize = 36
	textShadow.TextColor3 = Color3.fromRGB(100, 150, 255)
	textShadow.BackgroundTransparency = 1
	textShadow.TextTransparency = 0.7
	textShadow.ZIndex = -1
	
	-- Status indicator (shows if GUI is open)
	local statusIndicator = Instance.new("Frame", movableIcon)
	statusIndicator.Size = UDim2.new(0, 12, 0, 12)
	statusIndicator.Position = UDim2.new(1, -16, 0, 8)
	statusIndicator.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
	statusIndicator.BorderSizePixel = 0
	
	local statusCorner = Instance.new("UICorner", statusIndicator)
	statusCorner.CornerRadius = UDim.new(1, 0)
	
	local statusGlow = Instance.new("UIStroke", statusIndicator)
	statusGlow.Color = Color3.fromRGB(255, 255, 255)
	statusGlow.Thickness = 2
	statusGlow.Transparency = 0.5
	
	-- Pulsing animation for status
	task.spawn(function()
		while statusIndicator and statusIndicator.Parent do
			TweenService:Create(statusIndicator, TweenInfo.new(0.8, Enum.EasingStyle.Sine, Enum.EasingDirection.InOut, -1, true), {
				Size = UDim2.new(0, 14, 0, 14)
			}):Play()
			task.wait(1.6)
		end
	end)
	
	-- Dragging functionality (FIXED)
	movableIcon.InputBegan:Connect(function(input)
		if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
			iconDragging = true
			dragStartPosition = Vector2.new(input.Position.X, input.Position.Y)
			iconStartPosition = movableIcon.Position
			
			-- Visual feedback for dragging
			TweenService:Create(movableIcon, TweenInfo.new(0.15), {
				Size = UDim2.new(0, 75, 0, 75),
				BackgroundTransparency = 0.05
			}):Play()
			TweenService:Create(border, TweenInfo.new(0.15), {
				Thickness = 4,
				Transparency = 0.1
			}):Play()
			
			-- Disable click if it's a drag
			task.wait(0.1) -- Small delay to determine if it's a click or drag
		end
	end)
	
	UserInputService.InputChanged:Connect(function(input)
		if iconDragging and (input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch) then
			local delta = Vector2.new(
				input.Position.X - dragStartPosition.X,
				input.Position.Y - dragStartPosition.Y
			)
			
			local screenSize = workspace.CurrentCamera.ViewportSize
			local newX = math.clamp(iconStartPosition.X.Offset + delta.X, 40, screenSize.X - 40)
			local newY = math.clamp(iconStartPosition.Y.Offset + delta.Y, 40, screenSize.Y - 40)
			
			movableIcon.Position = UDim2.new(0, newX, 0, newY)
		end
	end)
	
	UserInputService.InputEnded:Connect(function(input)
		if (input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch) and iconDragging then
			iconDragging = false
			
			-- Save position
			local screenSize = workspace.CurrentCamera.ViewportSize
			UltraStorage.Settings.iconPosition = {
				X = movableIcon.Position.X.Offset / screenSize.X,
				Y = movableIcon.Position.Y.Offset / screenSize.Y
			}
			SaveAllData()
			
			-- Visual feedback
			TweenService:Create(movableIcon, TweenInfo.new(0.15), {
				Size = UDim2.new(0, 80, 0, 80),
				BackgroundTransparency = 0.15
			}):Play()
			TweenService:Create(border, TweenInfo.new(0.15), {
				Thickness = 3,
				Transparency = 0.2
			}):Play()
			
			-- Don't trigger click after drag
			return
		end
	end)
	
	-- CLICK HANDLER (FIXED - Now properly loads main GUI)
	movableIcon.MouseButton1Click:Connect(function()
		if not iconDragging then
			local currentTime = tick()
			if currentTime - iconLastClick > 0.3 then -- Prevent double click
				iconLastClick = currentTime
				
				-- Track stats
				UltraStorage.Stats.totalClicks = (UltraStorage.Stats.totalClicks or 0) + 1
				
				-- Click animation
				TweenService:Create(movableIcon, TweenInfo.new(0.1), {
					Size = UDim2.new(0, 70, 0, 70)
				}):Play()
				
				-- Play click sound
				if UltraStorage.Settings.volume > 0 then
					pcall(function()
						local clickSound = AssetLoader.LoadSound("4590662766")
						clickSound.Volume = UltraStorage.Settings.volume * 0.5
						clickSound.Parent = movableIcon
						clickSound:Play()
						game:GetService("Debris"):AddItem(clickSound, 2)
					end)
				end
				
				task.wait(0.1)
				
				TweenService:Create(movableIcon, TweenInfo.new(0.1), {
					Size = UDim2.new(0, 80, 0, 80)
				}):Play()
				
				-- Toggle main GUI
				local existingGUI = gui:FindFirstChild("MainGUI")
				if existingGUI then
					-- Close existing GUI with animation
					TweenService:Create(existingGUI, TweenInfo.new(0.3), {
						Size = UDim2.new(0, 0, 0, 0),
						Position = UDim2.new(0.5, 0, 0.5, 0)
					}):Play()
					task.wait(0.3)
					existingGUI:Destroy()
					
					-- Update status indicator
					statusIndicator.BackgroundColor3 = Color3.fromRGB(255, 50, 50)
					
					NotificationManager:Show("GUI Closed", "Main interface has been closed", 2, "info")
				else
					-- Create and show main GUI
					CreateMainGUI()
					
					-- Update status indicator
					statusIndicator.BackgroundColor3 = Color3.fromRGB(50, 255, 100)
					
					NotificationManager:Show("GUI Opened", "Ultra Enhancer is now active", 2, "success")
				end
				
				-- Fire event
				UltraStorage.Events.IconClicked:Fire()
			end
		end
	end)
	
	-- Hover effects
	movableIcon.MouseEnter:Connect(function()
		if not iconDragging then
			TweenService:Create(movableIcon, TweenInfo.new(0.2), {
				Size = UDim2.new(0, 85, 0, 85),
				BackgroundTransparency = 0
			}):Play()
			TweenService:Create(border, TweenInfo.new(0.2), {
				Thickness = 4,
				Transparency = 0.1
			}):Play()
			TweenService:Create(innerGlow, TweenInfo.new(0.2), {
				BackgroundTransparency = 0.9
			}):Play()
		end
	end)
	
	movableIcon.MouseLeave:Connect(function()
		if not iconDragging then
			TweenService:Create(movableIcon, TweenInfo.new(0.2), {
				Size = UDim2.new(0, 80, 0, 80),
				BackgroundTransparency = 0.15
			}):Play()
			TweenService:Create(border, TweenInfo.new(0.2), {
				Thickness = 3,
				Transparency = 0.2
			}):Play()
			TweenService:Create(innerGlow, TweenInfo.new(0.2), {
				BackgroundTransparency = 0.95
			}):Play()
		end
	end)
	
	-- Floating animation
	local floatOffset = Vector2.new(0, 0)
	local floatSpeed = 2
	local floatRadius = 5
	
	task.spawn(function()
		local startTime = tick()
		while movableIcon and movableIcon.Parent do
			if not iconDragging then
				local time = tick() - startTime
				floatOffset = Vector2.new(
					math.sin(time * floatSpeed) * floatRadius,
					math.cos(time * floatSpeed * 0.7) * floatRadius
				)
				
				movableIcon.Position = UDim2.new(
					0,
					movableIcon.Position.X.Offset + floatOffset.X,
					0,
					movableIcon.Position.Y.Offset + floatOffset.Y
				)
			end
			task.wait(0.016) -- ~60 FPS
		end
	end)
	
	movableIcon.Parent = gui
	
	-- Initial notification
	task.wait(1)
	NotificationManager:Show("Welcome", "Ultra Enhancer v3.0 loaded!", 3, "success")
	
	return movableIcon
end

----------------------------------------------------
-- ULTRA MODERN MAIN GUI
----------------------------------------------------
local mainGUI = nil
local shaderEffects = {}
local isGUIOpen = false

local function CreateMainGUI()
	-- Close existing GUI
	if mainGUI and mainGUI.Parent then
		mainGUI