--// ULTRA ENHANCER - FIXED VERSION
--// Proper loading sequence: Icon â†’ Telegram â†’ Main GUI

-- Wait for game to load
repeat task.wait() until game:IsLoaded()
repeat task.wait() until game.Players.LocalPlayer

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local Lighting = game:GetService("Lighting")

-- Get player
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Clear any existing GUI
if playerGui:FindFirstChild("UltraEnhancerGUI") then
    playerGui:FindFirstChild("UltraEnhancerGUI"):Destroy()
end

-- Create main GUI container
local gui = Instance.new("ScreenGui")
gui.Name = "UltraEnhancerGUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.DisplayOrder = 999
gui.Parent = playerGui

print("ðŸŽ® Ultra Enhancer - Initializing...")

----------------------------------------------------
-- SIMPLE STORAGE
----------------------------------------------------
local Storage = {
    popupShown = false,
    telegramClicked = false,
    shaderEnabled = false,
    iconPosition = {X = 0.5, Y = 0.4},
    windowPosition = {X = 0.5, Y = 0.5}
}

-- Save/Load functions
local function SaveSettings()
    _G.UltraEnhancer_Settings = Storage
end

local function LoadSettings()
    if _G.UltraEnhancer_Settings then
        for key, value in pairs(_G.UltraEnhancer_Settings) do
            Storage[key] = value
        end
    end
end

LoadSettings()

----------------------------------------------------
-- 1. CREATE SQUIRCLE ICON (ALWAYS CREATE FIRST)
----------------------------------------------------
local movableIcon = nil
local isDraggingIcon = false

local function CreateIcon()
    print("ðŸ–±ï¸ Creating squircle icon...")
    
    -- Remove existing icon
    if movableIcon and movableIcon.Parent then
        movableIcon:Destroy()
    end
    
    -- Create icon
    movableIcon = Instance.new("ImageButton")
    movableIcon.Name = "UltraIcon"
    movableIcon.Size = UDim2.new(0, 70, 0, 70)
    movableIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    movableIcon.AutoButtonColor = false
    movableIcon.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    movableIcon.BackgroundTransparency = 0.1
    
    -- Position (center top)
    local screenSize = workspace.CurrentCamera.ViewportSize
    movableIcon.Position = UDim2.new(
        Storage.iconPosition.X,
        Storage.iconPosition.X * screenSize.X,
        Storage.iconPosition.Y,
        Storage.iconPosition.Y * screenSize.Y
    )
    
    -- Squircle shape
    local corner = Instance.new("UICorner", movableIcon)
    corner.CornerRadius = UDim.new(0.3, 0)
    
    -- Border
    local stroke = Instance.new("UIStroke", movableIcon)
    stroke.Color = Color3.fromRGB(100, 150, 255)
    stroke.Thickness = 2
    
    -- Icon content
    local content = Instance.new("Frame", movableIcon)
    content.Size = UDim2.new(0.7, 0, 0.7, 0)
    content.Position = UDim2.new(0.15, 0, 0.15, 0)
    content.BackgroundTransparency = 1
    
    local iconText = Instance.new("TextLabel", content)
    iconText.Size = UDim2.new(1, 0, 1, 0)
    iconText.Text = "âš¡"
    iconText.Font = Enum.Font.GothamBold
    iconText.TextSize = 32
    iconText.TextColor3 = Color3.fromRGB(255, 255, 255)
    iconText.BackgroundTransparency = 1
    
    -- Dragging
    local dragStart, startPos
    
    movableIcon.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDraggingIcon = true
            dragStart = input.Position
            startPos = movableIcon.Position
            
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 65, 0, 65)
            }):Play()
        end
    end)
    
    movableIcon.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDraggingIcon = false
            
            -- Save position
            local screenSize = workspace.CurrentCamera.ViewportSize
            Storage.iconPosition = {
                X = movableIcon.Position.X.Offset / screenSize.X,
                Y = movableIcon.Position.Y.Offset / screenSize.Y
            }
            SaveSettings()
            
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 70, 0, 70)
            }):Play()
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if isDraggingIcon and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            movableIcon.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- CLICK HANDLER - THIS IS THE KEY FIX
    movableIcon.MouseButton1Click:Connect(function()
        if not isDraggingIcon then
            print("ðŸŽ¯ Icon clicked - Loading main script...")
            
            -- Click animation
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 60, 0, 60)
            }):Play()
            task.wait(0.1)
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 70, 0, 70)
            }):Play()
            
            -- Check if main GUI already exists
            if gui:FindFirstChild("MainGUI") then
                print("ðŸ“± Main GUI already loaded")
                return
            end
            
            -- LOAD THE MAIN SCRIPT WITH SHADER AND FPS BOOST
            CreateMainGUI()
        end
    end)
    
    -- Hover effects
    movableIcon.MouseEnter:Connect(function()
        TweenService:Create(movableIcon, TweenInfo.new(0.2), {
            Size = UDim2.new(0, 75, 0, 75)
        }):Play()
    end)
    
    movableIcon.MouseLeave:Connect(function()
        if not isDraggingIcon then
            TweenService:Create(movableIcon, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 70, 0, 70)
            }):Play()
        end
    end)
    
    movableIcon.Parent = gui
    print("âœ… Icon created successfully")
    return movableIcon
end

----------------------------------------------------
-- 2. TELEGRAM POPUP
----------------------------------------------------
local function CreateTelegramPopup()
    print("ðŸ“± Creating Telegram popup...")
    
    Storage.popupShown = true
    SaveSettings()
    
    -- Overlay
    local overlay = Instance.new("Frame", gui)
    overlay.Name = "PopupOverlay"
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    overlay.BackgroundTransparency = 0.5
    overlay.ZIndex = 10
    
    -- Popup
    local popup = Instance.new("Frame", overlay)
    popup.Name = "TelegramPopup"
    popup.Size = UDim2.new(0, 400, 0, 300)
    popup.Position = UDim2.new(0.5, 0, 0.5, 0)
    popup.AnchorPoint = Vector2.new(0.5, 0.5)
    popup.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    popup.ZIndex = 11
    
    local corner = Instance.new("UICorner", popup)
    corner.CornerRadius = UDim.new(0, 20)
    
    -- Title
    local title = Instance.new("TextLabel", popup)
    title.Size = UDim2.new(1, -40, 0, 60)
    title.Position = UDim2.new(0, 20, 0, 10)
    title.Text = "Join Our Telegram"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 24
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.BackgroundTransparency = 1
    
    -- Description
    local desc = Instance.new("TextLabel", popup)
    desc.Size = UDim2.new(1, -40, 0, 80)
    desc.Position = UDim2.new(0, 20, 0, 80)
    desc.Text = "Get daily scripts, tutorials, and exclusive content!"
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 16
    desc.TextColor3 = Color3.fromRGB(200, 200, 220)
    desc.BackgroundTransparency = 1
    desc.TextWrapped = true
    
    -- Telegram button
    local tgButton = Instance.new("TextButton", popup)
    tgButton.Size = UDim2.new(1, -40, 0, 50)
    tgButton.Position = UDim2.new(0, 20, 0, 180)
    tgButton.Text = "Join Telegram Group"
    tgButton.Font = Enum.Font.GothamBold
    tgButton.TextSize = 18
    tgButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tgButton.BackgroundColor3 = Color3.fromRGB(34, 158, 217)
    
    local tgCorner = Instance.new("UICorner", tgButton)
    tgCorner.CornerRadius = UDim.new(0, 12)
    
    -- Continue button
    local continueButton = Instance.new("TextButton", popup)
    continueButton.Size = UDim2.new(1, -40, 0, 40)
    continueButton.Position = UDim2.new(0, 20, 0, 240)
    continueButton.Text = "Continue Without Joining"
    continueButton.Font = Enum.Font.Gotham
    continueButton.TextSize = 14
    continueButton.TextColor3 = Color3.fromRGB(180, 180, 200)
    continueButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    
    local continueCorner = Instance.new("UICorner", continueButton)
    continueCorner.CornerRadius = UDim.new(0, 10)
    
    -- Animate in
    popup.Size = UDim2.new(0, 0, 0, 0)
    popup:TweenSize(UDim2.new(0, 400, 0, 300), "Out", "Back", 0.5, true)
    
    -- Button handlers
    tgButton.MouseButton1Click:Connect(function()
        Storage.telegramClicked = true
        SaveSettings()
        
        -- Copy link
        local url = "https://t.me/RBLX_SCRIPTS_MYANMAR"
        pcall(function()
            if setclipboard then
                setclipboard(url)
                tgButton.Text = "Link Copied!"
                task.wait(1)
                tgButton.Text = "Join Telegram Group"
            end
        end)
        
        -- Close popup
        popup:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
        task.wait(0.4)
        overlay:Destroy()
        
        print("âœ… Telegram clicked - Popup closed")
    end)
    
    continueButton.MouseButton1Click:Connect(function()
        Storage.telegramClicked = false
        SaveSettings()
        
        -- Close popup
        popup:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
        task.wait(0.4)
        overlay:Destroy()
        
        print("âœ… Continue clicked - Popup closed")
    end)
    
    print("âœ… Telegram popup created")
end

----------------------------------------------------
-- 3. MAIN SCRIPT WITH SHADER AND FPS BOOST
----------------------------------------------------
local shaderEffects = {}

local function CreateMainGUI()
    print("ðŸ–¥ï¸ Loading main script with features...")
    
    -- Create main frame
    local mainFrame = Instance.new("Frame", gui)
    mainFrame.Name = "MainGUI"
    mainFrame.Size = UDim2.new(0, 350, 0, 400)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    mainFrame.Active = true
    mainFrame.Draggable = false
    
    -- Position
    local screenSize = workspace.CurrentCamera.ViewportSize
    mainFrame.Position = UDim2.new(
        Storage.windowPosition.X,
        Storage.windowPosition.X * screenSize.X,
        Storage.windowPosition.Y,
        Storage.windowPosition.Y * screenSize.Y
    )
    
    -- Style
    local corner = Instance.new("UICorner", mainFrame)
    corner.CornerRadius = UDim.new(0, 20)
    
    local stroke = Instance.new("UIStroke", mainFrame)
    stroke.Color = Color3.fromRGB(60, 60, 80)
    stroke.Thickness = 2
    
    -- Title bar
    local titleBar = Instance.new("Frame", mainFrame)
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    titleBar.BorderSizePixel = 0
    
    local titleCorner = Instance.new("UICorner", titleBar)
    titleCorner.CornerRadius = UDim.new(0, 20, 0, 0)
    
    local title = Instance.new("TextLabel", titleBar)
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.Text = "Ultra Enhancer"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.TextColor3 = Color3.fromRGB(220, 220, 255)
    title.BackgroundTransparency = 1
    title.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Close button
    local closeBtn = Instance.new("TextButton", titleBar)
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0.5, -15)
    closeBtn.Text = "Ã—"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 24
    closeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
    closeBtn.BackgroundTransparency = 1
    
    closeBtn.MouseButton1Click:Connect(function()
        -- Save position
        local screenSize = workspace.CurrentCamera.ViewportSize
        Storage.windowPosition = {
            X = mainFrame.Position.X.Offset / screenSize.X,
            Y = mainFrame.Position.Y.Offset / screenSize.Y
        }
        SaveSettings()
        
        -- Close GUI and hide icon
        TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0)
        }):Play()
        
        if movableIcon and movableIcon.Parent then
            TweenService:Create(movableIcon, TweenInfo.new(0.3), {
                Size = UDim2.new(0, 0, 0, 0)
            }):Play()
        end
        
        task.wait(0.3)
        
        -- Cleanup
        mainFrame:Destroy()
        if movableIcon and movableIcon.Parent then
            movableIcon:Destroy()
            movableIcon = nil
        end
        
        print("âœ… GUI and icon closed")
    end)
    
    -- Content area
    local content = Instance.new("Frame", mainFrame)
    content.Size = UDim2.new(1, -20, 1, -60)
    content.Position = UDim2.new(0, 10, 0, 50)
    content.BackgroundTransparency = 1
    
    -- ========== SHADER TOGGLE ==========
    local shaderBtn = Instance.new("TextButton", content)
    shaderBtn.Name = "ShaderButton"
    shaderBtn.Size = UDim2.new(1, 0, 0, 50)
    shaderBtn.Position = UDim2.new(0, 0, 0, 0)
    shaderBtn.Text = Storage.shaderEnabled and "Disable Shader" or "Enable Shader"
    shaderBtn.Font = Enum.Font.GothamSemibold
    shaderBtn.TextSize = 16
    shaderBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    shaderBtn.BackgroundColor3 = Storage.shaderEnabled and Color3.fromRGB(60, 100, 180) or Color3.fromRGB(40, 40, 60)
    
    local shaderCorner = Instance.new("UICorner", shaderBtn)
    shaderCorner.CornerRadius = UDim.new(0, 12)
    
    local shaderStroke = Instance.new("UIStroke", shaderBtn)
    shaderStroke.Color = Color3.fromRGB(80, 120, 255)
    shaderStroke.Thickness = 2
    
    -- ========== FPS BOOST ==========
    local fpsBtn = Instance.new("TextButton", content)
    fpsBtn.Name = "FPSButton"
    fpsBtn.Size = UDim2.new(1, 0, 0, 50)
    fpsBtn.Position = UDim2.new(0, 0, 0, 60)
    fpsBtn.Text = "Optimize Performance"
    fpsBtn.Font = Enum.Font.GothamSemibold
    fpsBtn.TextSize = 16
    fpsBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    fpsBtn.BackgroundColor3 = Color3.fromRGB(50, 60, 80)
    
    local fpsCorner = Instance.new("UICorner", fpsBtn)
    fpsCorner.CornerRadius = UDim.new(0, 12)
    
    local fpsStroke = Instance.new("UIStroke", fpsBtn)
    fpsStroke.Color = Color3.fromRGB(100, 200, 100)
    fpsStroke.Thickness = 2
    
    -- ========== FPS COUNTER ==========
    local fpsLabel = Instance.new("TextLabel", content)
    fpsLabel.Name = "FPSLabel"
    fpsLabel.Size = UDim2.new(1, 0, 0, 40)
    fpsLabel.Position = UDim2.new(0, 0, 0, 120)
    fpsLabel.Text = "FPS: --"
    fpsLabel.Font = Enum.Font.GothamSemibold
    fpsLabel.TextSize = 20
    fpsLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
    fpsLabel.BackgroundTransparency = 1
    fpsLabel.TextXAlignment = Enum.TextXAlignment.Center
    
    -- ========== SHADER TOGGLE FUNCTIONALITY ==========
    shaderBtn.MouseButton1Click:Connect(function()
        Storage.shaderEnabled = not Storage.shaderEnabled
        SaveSettings()
        
        if Storage.shaderEnabled then
            -- Enable ultra shader
            shaderBtn.Text = "Disable Shader"
            TweenService:Create(shaderBtn, TweenInfo.new(0.3), {
                BackgroundColor3 = Color3.fromRGB(60, 100, 180)
            }):Play()
            
            -- Apply enhanced graphics
            Lighting.Ambient = Color3.fromRGB(25, 28, 35)
            Lighting.Brightness = 2.0
            Lighting.GlobalShadows = true
            Lighting.ShadowSoftness = 0.05
            Lighting.ClockTime = 14
            
            -- Create effects
            local bloom = Instance.new("BloomEffect", Lighting)
            bloom.Intensity = 0.3
            bloom.Size = 36
            bloom.Threshold = 0.85
            table.insert(shaderEffects, bloom)
            
            local colorCorrection = Instance.new("ColorCorrectionEffect", Lighting)
            colorCorrection.Brightness = 0.1
            colorCorrection.Contrast = 0.4
            colorCorrection.Saturation = 0.15
            table.insert(shaderEffects, colorCorrection)
            
            print("âœ… Ultra shader enabled")
        else
            -- Disable shader
            shaderBtn.Text = "Enable Shader"
            TweenService:Create(shaderBtn, TweenInfo.new(0.3), {
                BackgroundColor3 = Color3.fromRGB(40, 40, 60)
            }):Play()
            
            -- Remove effects
            for _, effect in ipairs(shaderEffects) do
                if effect then
                    effect:Destroy()
                end
            end
            shaderEffects = {}
            
            -- Reset lighting
            Lighting.Ambient = Color3.fromRGB(127, 127, 127)
            Lighting.Brightness = 1
            
            print("âœ… Ultra shader disabled")
        end
    end)
    
    -- ========== FPS BOOST FUNCTIONALITY ==========
    fpsBtn.MouseButton1Click:Connect(function()
        -- Optimize game performance
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") then
                obj.Material = Enum.Material.SmoothPlastic
            elseif obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
                obj.Enabled = false
            end
        end
        
        settings().Rendering.QualityLevel = 1
        Lighting.GlobalShadows = true
        Lighting.FogEnd = 100000
        
        fpsBtn.Text = "Optimized!"
        TweenService:Create(fpsBtn, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(30, 150, 60)
        }):Play()
        
        task.wait(1.5)
        
        fpsBtn.Text = "Optimize Performance"
        TweenService:Create(fpsBtn, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(50, 60, 80)
        }):Play()
        
        print("âœ… Game optimized for FPS")
    end)
    
    -- ========== FPS COUNTER FUNCTIONALITY ==========
    local lastUpdate = tick()
    local frameCount = 0
    
    RunService.RenderStepped:Connect(function()
        frameCount = frameCount + 1
        local currentTime = tick()
        
        if currentTime - lastUpdate >= 1 then
            local fps = frameCount
            frameCount = 0
            lastUpdate = currentTime
            
            fpsLabel.Text = string.format("FPS: %d", fps)
            
            -- Color coding
            if fps >= 60 then
                fpsLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
            elseif fps >= 30 then
                fpsLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            else
                fpsLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
        end
    end)
    
    -- Animate GUI opening
    mainFrame.Size = UDim2.new(0, 0, 0, 0)
    mainFrame:TweenSize(UDim2.new(0, 350, 0, 400), "Out", "Back", 0.5, true)
    
    print("âœ… Main script with shader and FPS boost loaded successfully")
    return mainFrame
end

----------------------------------------------------
-- MAIN LOADING SEQUENCE (FIXED)
----------------------------------------------------
print("ðŸš€ Starting loading sequence...")

-- Step 1: ALWAYS create the icon first (but it might not be visible yet)
CreateIcon()

-- Step 2: Check if we should show Telegram popup
if not Storage.popupShown then
    print("ðŸ“± Showing Telegram popup (first time)")
    -- Hide icon while popup is shown
    if movableIcon and movableIcon.Parent then
        movableIcon.Visible = false
    end
    
    -- Create popup
    CreateTelegramPopup()
    
    -- After popup closes (via Continue button), icon should appear
    -- This happens in the popup's button handlers
else
    print("ðŸ“± Telegram already shown, showing icon directly")
    -- Icon is already visible from CreateIcon()
end

-- Auto-save on game close
game:BindToClose(function()
    SaveSettings()
    print("ðŸ’¾ Settings saved")
end)

print("âœ… Ultra Enhancer ready!")
print("ðŸ“Š Status:")
print("   Icon created:", movableIcon ~= nil)
print("   Popup shown:", Storage.popupShown)
print("   Telegram clicked:", Storage.telegramClicked)

-- Fix for Telegram popup button handlers to show icon after clicking Continue
-- We need to modify the popup button handlers
-- Actually, we need to ensure the icon becomes visible after popup closes

-- Let's add a function to show the icon
local function ShowIcon()
    if movableIcon and movableIcon.Parent then
        movableIcon.Visible = true
        print("âœ… Icon made visible")
    else
        CreateIcon()
        print("âœ… Icon recreated")
    end
end

-- Now modify the Telegram popup creation to use this
-- We need to override the popup creation to include ShowIcon call
-- But since we can't modify after creation, we'll add it here

-- Add an event listener for when popup closes
-- Actually, let's rewrite the popup creation with proper icon handling

-- Replace the Telegram popup function with fixed version
-- We'll store the original and override it
local originalCreateTelegramPopup = CreateTelegramPopup

CreateTelegramPopup = function()
    print("ðŸ“± Creating Telegram popup with fixed icon handling...")
    
    Storage.popupShown = true
    SaveSettings()
    
    -- Overlay
    local overlay = Instance.new("Frame", gui)
    overlay.Name = "PopupOverlay"
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    overlay.BackgroundTransparency = 0.5
    overlay.ZIndex = 10
    
    -- Popup
    local popup = Instance.new("Frame", overlay)
    popup.Name = "TelegramPopup"
    popup.Size = UDim2.new(0, 400, 0, 300)
    popup.Position = UDim2.new(0.5, 0, 0.5, 0)
    popup.AnchorPoint = Vector2.new(0.5, 0.5)
    popup.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    popup.ZIndex = 11
    
    local corner = Instance.new("UICorner", popup)
    corner.CornerRadius = UDim.new(0, 20)
    
    -- Title
    local title = Instance.new("TextLabel", popup)
    title.Size = UDim2.new(1, -40, 0, 60)
    title.Position = UDim2.new(0, 20, 0, 10)
    title.Text = "Join Our Telegram"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 24
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.BackgroundTransparency = 1
    
    -- Description
    local desc = Instance.new("TextLabel", popup)
    desc.Size = UDim2.new(1, -40, 0, 80)
    desc.Position = UDim2.new(0, 20, 0, 80)
    desc.Text = "Get daily scripts, tutorials, and exclusive content!"
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 16
    desc.TextColor3 = Color3.fromRGB(200, 200, 220)
    desc.BackgroundTransparency = 1
    desc.TextWrapped = true
    
    -- Telegram button
    local tgButton = Instance.new("TextButton", popup)
    tgButton.Size = UDim2.new(1, -40, 0, 50)
    tgButton.Position = UDim2.new(0, 20, 0, 180)
    tgButton.Text = "Join Telegram Group"
    tgButton.Font = Enum.Font.GothamBold
    tgButton.TextSize = 18
    tgButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tgButton.BackgroundColor3 = Color3.fromRGB(34, 158, 217)
    
    local tgCorner = Instance.new("UICorner", tgButton)
    tgCorner.CornerRadius = UDim.new(0, 12)
    
    -- Continue button (IMPORTANT - THIS SHOWS THE ICON)
    local continueButton = Instance.new("TextButton", popup)
    continueButton.Size = UDim2.new(1, -40, 0, 40)
    continueButton.Position = UDim2.new(0, 20, 0, 240)
    continueButton.Text = "Continue Without Joining"
    continueButton.Font = Enum.Font.Gotham
    continueButton.TextSize = 14
    continueButton.TextColor3 = Color3.fromRGB(180, 180, 200)
    continueButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    
    local continueCorner = Instance.new("UICorner", continueButton)
    continueCorner.CornerRadius = UDim.new(0, 10)
    
    -- Animate in
    popup.Size = UDim2.new(0, 0, 0, 0)
    popup:TweenSize(UDim2.new(0, 400, 0, 300), "Out", "Back", 0.5, true)
    
    -- Button handlers
    tgButton.MouseButton1Click:Connect(function()
        Storage.telegramClicked = true
        SaveSettings()
        
        -- Copy link
        local url = "https://t.me/RBLX_SCRIPTS_MYANMAR"
        pcall(function()
            if setclipboard then
                setclipboard(url)
                tgButton.Text = "Link Copied!"
                task.wait(1)
                tgButton.Text = "Join Telegram Group"
            end
        end)
        
        -- Close popup
        popup:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
        task.wait(0.4)
        overlay:Destroy()
        
        -- SHOW THE ICON AFTER POPUP CLOSES
        ShowIcon()
        print("âœ… Telegram clicked - Icon shown")
    end)
    
    continueButton.MouseButton1Click:Connect(function()
        Storage.telegramClicked = false
        SaveSettings()
        
        -- Close popup
        popup:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
        task.wait(0.4)
        overlay:Destroy()
        
        -- SHOW THE ICON AFTER POPUP CLOSES
        ShowIcon()
        print("âœ… Continue clicked - Icon shown")
    end)
    
    print("âœ… Telegram popup created (icon will show after clicking Continue)")
end

-- Now reinitialize with the fixed version
print("ðŸ”„ Reinitializing with fixed loading sequence...")

-- Hide icon initially
if movableIcon and movableIcon.Parent then
    movableIcon.Visible = false
end

-- Check if we need to show popup
if not Storage.popupShown then
    print("ðŸ“± Launching Telegram popup")
    task.wait(1) -- Small delay
    CreateTelegramPopup()
else
    print("ðŸ“± Telegram already seen, showing icon directly")
    ShowIcon()
end

print("ðŸŽ‰ Ultra Enhancer fully initialized!")
print("ðŸ‘‰ Click the blue squircle icon to load shader and FPS boost")