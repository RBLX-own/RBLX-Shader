-- ULTRA ENHANCER - Movable Toggle Squircle Button
-- Toggles FPS Boost + Shader when clicked
-- Icon stays movable in the middle initially

repeat task.wait() until game:IsLoaded()
repeat task.wait() until game.Players.LocalPlayer

local Players        = game:GetService("Players")
local TweenService   = game:GetService("TweenService")
local UserInputService = game:GetService("UserInputService")
local RunService     = game:GetService("RunService")
local Lighting       = game:GetService("Lighting")

local player    = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Clear previous
if playerGui:FindFirstChild("UltraEnhancerGUI") then
    playerGui.UltraEnhancerGUI:Destroy()
end

local gui = Instance.new("ScreenGui")
gui.Name = "UltraEnhancerGUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.DisplayOrder = 15
gui.Parent = playerGui

print("Ultra Enhancer loading...")

-- ──────────────────────────────────────────────
--                   SETTINGS
-- ──────────────────────────────────────────────
local Storage = {
    iconPosition = {X = 0.5, Y = 0.5},
    isEnabled    = false,          -- current toggle state
}

local function SaveSettings()
    _G.UltraEnhancer_Data = Storage
end

local function LoadSettings()
    if _G.UltraEnhancer_Data then
        for k, v in pairs(_G.UltraEnhancer_Data) do
            Storage[k] = v
        end
    end
end

LoadSettings()

-- ──────────────────────────────────────────────
--              MOVABLE TOGGLE ICON
-- ──────────────────────────────────────────────
local icon, isDragging, dragStart, startPos
local activeEffects = {}   -- store connections / objects to clean up

local function DestroyEffects()
    for _, obj in pairs(activeEffects) do
        if typeof(obj) == "RBXScriptConnection" then
            obj:Disconnect()
        elseif obj.Destroy then
            obj:Destroy()
        end
    end
    activeEffects = {}
    Storage.isEnabled = false
    SaveSettings()
end

local function ApplyEnhancements()
    DestroyEffects()    -- clean previous

    Storage.isEnabled = true
    SaveSettings()

    -- ─── FPS BOOST ───────────────────────────────────────
    local lightingProps = {
        GlobalShadows   = false,
        Brightness      = 1,
        ClockTime       = 14,
        FogEnd          = 9999,
        EnvironmentDiffuseScale = 0,
        EnvironmentSpecularScale = 0,
    }

    for prop, value in pairs(lightingProps) do
        if Lighting[prop] ~= value then
            Lighting[prop] = value
        end
    end

    -- Remove heavy post-effects
    for _, effect in pairs(Lighting:GetChildren()) do
        if effect:IsA("PostEffect") or effect:IsA("Sky") or effect:IsA("BloomEffect") or
           effect:IsA("BlurEffect") or effect:IsA("DepthOfFieldEffect") or
           effect:IsA("SunRaysEffect") then
            table.insert(activeEffects, effect)
            effect.Enabled = false
        end
    end

    -- ─── SHADER (simple but visible color + bloom-like) ──
    local colorCorrection = Instance.new("ColorCorrectionEffect")
    colorCorrection.Name = "UltraColor"
    colorCorrection.Parent = Lighting
    colorCorrection.Enabled = true
    colorCorrection.Brightness = 0.12
    colorCorrection.Contrast = 0.25
    colorCorrection.Saturation = 0.4
    colorCorrection.TintColor = Color3.fromRGB(245, 235, 255)

    local bloom = Instance.new("BloomEffect")
    bloom.Name = "UltraBloom"
    bloom.Parent = Lighting
    bloom.Intensity = 0.9
    bloom.Size = 32
    bloom.Threshold = 1.1
    bloom.Enabled = true

    table.insert(activeEffects, colorCorrection)
    table.insert(activeEffects, bloom)

    print("Ultra Enhancer → ACTIVATED")
end

local function CreateToggleIcon()

    if icon then icon:Destroy() end

    icon = Instance.new("ImageButton")
    icon.Name = "EnhancerToggle"
    icon.Size = UDim2.new(0, 90, 0, 90)
    icon.AnchorPoint = Vector2.new(0.5, 0.5)
    icon.AutoButtonColor = false
    icon.BackgroundColor3 = Color3.fromRGB(30, 30, 55)
    icon.BackgroundTransparency = 0.15
    icon.ZIndex = 10

    -- Initial position (normalized → absolute)
    local cam = workspace.CurrentCamera
    local screen = cam.ViewportSize
    icon.Position = UDim2.new(
        Storage.iconPosition.X, Storage.iconPosition.X * screen.X,
        Storage.iconPosition.Y, Storage.iconPosition.Y * screen.Y
    )

    local corner = Instance.new("UICorner")
    corner.CornerRadius = UDim.new(0.5, 0)   -- almost circle → squircle
    corner.Parent = icon

    local stroke = Instance.new("UIStroke")
    stroke.Color = Color3.fromRGB(90, 140, 255)
    stroke.Thickness = 2.5
    stroke.Transparency = 0.3
    stroke.Parent = icon

    -- Inner symbol
    local symbol = Instance.new("TextLabel", icon)
    symbol.Size = UDim2.new(1,0,1,0)
    symbol.BackgroundTransparency = 1
    symbol.Font = Enum.Font.GothamBlack
    symbol.Text = "⚡"
    symbol.TextColor3 = Color3.new(1,1,1)
    symbol.TextSize = 48
    symbol.TextStrokeTransparency = 0.7
    symbol.TextStrokeColor3 = Color3.new(0,0,0)

    -- ─── DRAGGING ───────────────────────────────────────
    icon.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            isDragging = true
            dragStart = Vector2.new(input.Position.X, input.Position.Y)
            startPos  = icon.Position
            TweenService:Create(icon, TweenInfo.new(0.2), {BackgroundTransparency = 0}):Play()
        end
    end)

    icon.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or
           input.UserInputType == Enum.UserInputType.Touch then
            isDragging = false
            -- save normalized position
            local sz = workspace.CurrentCamera.ViewportSize
            Storage.iconPosition.X = icon.Position.X.Offset / sz.X
            Storage.iconPosition.Y = icon.Position.Y.Offset / sz.Y
            SaveSettings()
            TweenService:Create(icon, TweenInfo.new(0.2), {BackgroundTransparency = 0.15}):Play()
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if not isDragging then return end
        if input.UserInputType ~= Enum.UserInputType.MouseMovement and
           input.UserInputType ~= Enum.UserInputType.Touch then return end

        local delta = Vector2.new(input.Position.X - dragStart.X, input.Position.Y - dragStart.Y)
        icon.Position = UDim2.new(
            startPos.X.Scale,
            startPos.X.Offset + delta.X,
            startPos.Y.Scale,
            startPos.Y.Offset + delta.Y
        )
    end)

    -- ─── TOGGLE LOGIC ───────────────────────────────────
    local function updateVisual()
        if Storage.isEnabled then
            stroke.Color = Color3.fromRGB(40, 255, 120)
            stroke.Thickness = 3.5
            symbol.TextColor3 = Color3.fromRGB(120, 255, 160)
            TweenService:Create(icon, TweenInfo.new(0.4), {BackgroundColor3 = Color3.fromRGB(45, 70, 50)}):Play()
        else
            stroke.Color = Color3.fromRGB(90, 140, 255)
            stroke.Thickness = 2.5
            symbol.TextColor3 = Color3.new(1,1,1)
            TweenService:Create(icon, TweenInfo.new(0.4), {BackgroundColor3 = Color3.fromRGB(30, 30, 55)}):Play()
        end
    end

    icon.MouseButton1Click:Connect(function()
        if isDragging then return end

        if Storage.isEnabled then
            DestroyEffects()
            print("Ultra Enhancer → DEACTIVATED")
        else
            ApplyEnhancements()
        end

        updateVisual()
    end)

    -- Initial visual state
    updateVisual()

    -- subtle float animation
    task.spawn(function()
        local t = 0
        while icon.Parent do
            if not isDragging then
                t += 0.035
                local offsetY = math.sin(t) * 3
                icon.Position += UDim2.new(0,0,0,offsetY - (icon.Position.Y.Offset % 1))
            end
            task.wait(0.07)
        end
    end)

    icon.Parent = gui
    print("Toggle icon created")
end

-- Start
CreateToggleIcon()

-- Re-create icon if player respawns (optional improvement)
player.CharacterAdded:Connect(function()
    task.wait(1.5)
    CreateToggleIcon()
end)