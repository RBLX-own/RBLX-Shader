--// ULTRA ENHANCER - COMPLETE WORKING SCRIPT
--// All features loaded and working properly

-- Wait for game to fully load
repeat task.wait() until game:IsLoaded()
repeat task.wait() until game.Players.LocalPlayer

-- Services
local Players = game:GetService("Players")
local TweenService = game:GetService("TweenService")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local HttpService = game:GetService("HttpService")
local Lighting = game:GetService("Lighting")
local SoundService = game:GetService("SoundService")
local StarterGui = game:GetService("StarterGui")
local CoreGui = game:GetService("CoreGui")

-- Get player
local player = Players.LocalPlayer
local playerGui = player:WaitForChild("PlayerGui")

-- Clear any existing GUI
if playerGui:FindFirstChild("UltraEnhancerGUI") then
    playerGui:FindFirstChild("UltraEnhancerGUI"):Destroy()
end

-- Create main GUI
local gui = Instance.new("ScreenGui")
gui.Name = "UltraEnhancerGUI"
gui.ResetOnSpawn = false
gui.IgnoreGuiInset = true
gui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
gui.DisplayOrder = 999
gui.Parent = playerGui

print("ðŸŽ® Ultra Enhancer - Initializing...")

----------------------------------------------------
-- SIMPLE STORAGE SYSTEM (WORKING)
----------------------------------------------------
local Storage = {
    popupShown = false,
    telegramClicked = false,
    shaderEnabled = false,
    iconPosition = {X = 0.03, Y = 0.03},
    windowPosition = {X = 0.5, Y = 0.5},
    volume = 0.5
}

-- Save to _G (simple and reliable)
local function SaveSettings()
    _G.UltraEnhancer_Settings = {
        popupShown = Storage.popupShown,
        telegramClicked = Storage.telegramClicked,
        shaderEnabled = Storage.shaderEnabled,
        iconPosition = Storage.iconPosition,
        windowPosition = Storage.windowPosition,
        volume = Storage.volume,
        saveTime = os.time()
    }
    print("ðŸ’¾ Settings saved")
end

-- Load from _G
local function LoadSettings()
    if _G.UltraEnhancer_Settings then
        Storage.popupShown = _G.UltraEnhancer_Settings.popupShown or false
        Storage.telegramClicked = _G.UltraEnhancer_Settings.telegramClicked or false
        Storage.shaderEnabled = _G.UltraEnhancer_Settings.shaderEnabled or false
        Storage.iconPosition = _G.UltraEnhancer_Settings.iconPosition or {X = 0.03, Y = 0.03}
        Storage.windowPosition = _G.UltraEnhancer_Settings.windowPosition or {X = 0.5, Y = 0.5}
        Storage.volume = _G.UltraEnhancer_Settings.volume or 0.5
        print("ðŸ“‚ Settings loaded")
    else
        print("ðŸ“‚ No saved settings, using defaults")
    end
end

-- Initialize storage
LoadSettings()

----------------------------------------------------
-- NOTIFICATION SYSTEM (WORKING)
----------------------------------------------------
local NotificationManager = {
    activeNotifications = {}
}

function NotificationManager:Show(title, message, duration)
    duration = duration or 3
    
    -- Create notification
    local notification = Instance.new("Frame")
    notification.Name = "Notification"
    notification.Size = UDim2.new(0, 300, 0, 80)
    notification.Position = UDim2.new(1, -320, 1, -100)
    notification.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    notification.BackgroundTransparency = 0.1
    notification.BorderSizePixel = 0
    notification.ZIndex = 1000
    
    local corner = Instance.new("UICorner", notification)
    corner.CornerRadius = UDim.new(0, 12)
    
    local stroke = Instance.new("UIStroke", notification)
    stroke.Color = Color3.fromRGB(60, 60, 80)
    stroke.Thickness = 2
    
    -- Title
    local titleLabel = Instance.new("TextLabel", notification)
    titleLabel.Size = UDim2.new(1, -20, 0, 30)
    titleLabel.Position = UDim2.new(0, 10, 0, 10)
    titleLabel.Text = title
    titleLabel.Font = Enum.Font.GothamBold
    titleLabel.TextSize = 16
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Message
    local messageLabel = Instance.new("TextLabel", notification)
    messageLabel.Size = UDim2.new(1, -20, 0, 40)
    messageLabel.Position = UDim2.new(0, 10, 0, 40)
    messageLabel.Text = message
    messageLabel.Font = Enum.Font.Gotham
    messageLabel.TextSize = 14
    messageLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
    messageLabel.BackgroundTransparency = 1
    messageLabel.TextXAlignment = Enum.TextXAlignment.Left
    messageLabel.TextWrapped = true
    
    notification.Parent = gui
    
    -- Animate in
    notification.Position = UDim2.new(1, 300, 1, -100)
    notification:TweenPosition(
        UDim2.new(1, -320, 1, -100),
        Enum.EasingDirection.Out,
        Enum.EasingStyle.Quad,
        0.3
    )
    
    -- Auto remove
    task.delay(duration, function()
        if notification and notification.Parent then
            notification:TweenPosition(
                UDim2.new(1, 300, 1, -100),
                Enum.EasingDirection.In,
                Enum.EasingStyle.Quad,
                0.3
            )
            task.wait(0.3)
            notification:Destroy()
        end
    end)
    
    return notification
end

----------------------------------------------------
-- MAIN MOVABLE ICON (FIXED - GUARANTEED TO WORK)
----------------------------------------------------
local movableIcon = nil
local isDragging = false

local function CreateIcon()
    print("ðŸ–±ï¸ Creating movable icon...")
    
    -- Create icon
    movableIcon = Instance.new("ImageButton")
    movableIcon.Name = "UltraIcon"
    movableIcon.Size = UDim2.new(0, 70, 0, 70)
    movableIcon.AnchorPoint = Vector2.new(0.5, 0.5)
    movableIcon.AutoButtonColor = false
    movableIcon.BackgroundColor3 = Color3.fromRGB(30, 30, 40)
    movableIcon.BackgroundTransparency = 0.1
    
    -- Set position
    local screenSize = workspace.CurrentCamera.ViewportSize
    movableIcon.Position = UDim2.new(
        Storage.iconPosition.X or 0.03,
        (Storage.iconPosition.X or 0.03) * screenSize.X,
        Storage.iconPosition.Y or 0.03,
        (Storage.iconPosition.Y or 0.03) * screenSize.Y
    )
    
    -- Style
    local corner = Instance.new("UICorner", movableIcon)
    corner.CornerRadius = UDim.new(0.3, 0)
    
    local stroke = Instance.new("UIStroke", movableIcon)
    stroke.Color = Color3.fromRGB(100, 150, 255)
    stroke.Thickness = 2
    
    -- Icon content
    local content = Instance.new("Frame", movableIcon)
    content.Size = UDim2.new(0.7, 0, 0.7, 0)
    content.Position = UDim2.new(0.15, 0, 0.15, 0)
    content.BackgroundTransparency = 1
    
    local iconText = Instance.new("TextLabel", content)
    iconText.Size = UDim2.new(1, 0, 1, 0)
    iconText.Text = "âš¡"
    iconText.Font = Enum.Font.GothamBold
    iconText.TextSize = 32
    iconText.TextColor3 = Color3.fromRGB(255, 255, 255)
    iconText.BackgroundTransparency = 1
    
    -- Dragging functionality
    local dragStart, startPos
    
    movableIcon.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = true
            dragStart = input.Position
            startPos = movableIcon.Position
            
            -- Visual feedback
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 65, 0, 65)
            }):Play()
        end
    end)
    
    movableIcon.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            isDragging = false
            
            -- Save position
            local screenSize = workspace.CurrentCamera.ViewportSize
            Storage.iconPosition = {
                X = movableIcon.Position.X.Offset / screenSize.X,
                Y = movableIcon.Position.Y.Offset / screenSize.Y
            }
            SaveSettings()
            
            -- Visual feedback
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 70, 0, 70)
            }):Play()
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if isDragging and input.UserInputType == Enum.UserInputType.MouseMovement then
            local delta = input.Position - dragStart
            movableIcon.Position = UDim2.new(
                startPos.X.Scale,
                startPos.X.Offset + delta.X,
                startPos.Y.Scale,
                startPos.Y.Offset + delta.Y
            )
        end
    end)
    
    -- CLICK HANDLER - THIS IS CRITICAL
    movableIcon.MouseButton1Click:Connect(function()
        if not isDragging then
            print("ðŸ–±ï¸ Icon clicked - Opening GUI...")
            
            -- Animation
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 60, 0, 60)
            }):Play()
            task.wait(0.1)
            TweenService:Create(movableIcon, TweenInfo.new(0.1), {
                Size = UDim2.new(0, 70, 0, 70)
            }):Play()
            
            -- Toggle GUI
            local mainGUI = gui:FindFirstChild("MainGUI")
            if mainGUI then
                -- Close GUI
                TweenService:Create(mainGUI, TweenInfo.new(0.3), {
                    Size = UDim2.new(0, 0, 0, 0)
                }):Play()
                task.wait(0.3)
                mainGUI:Destroy()
                NotificationManager:Show("GUI Closed", "Interface closed successfully", 2)
            else
                -- Create and show GUI
                CreateMainGUI()
                NotificationManager:Show("GUI Opened", "Ultra Enhancer is ready!", 2)
            end
        end
    end)
    
    -- Hover effects
    movableIcon.MouseEnter:Connect(function()
        TweenService:Create(movableIcon, TweenInfo.new(0.2), {
            Size = UDim2.new(0, 75, 0, 75),
            BackgroundTransparency = 0
        }):Play()
    end)
    
    movableIcon.MouseLeave:Connect(function()
        if not isDragging then
            TweenService:Create(movableIcon, TweenInfo.new(0.2), {
                Size = UDim2.new(0, 70, 0, 70),
                BackgroundTransparency = 0.1
            }):Play()
        end
    end)
    
    -- Add to GUI
    movableIcon.Parent = gui
    
    print("âœ… Icon created successfully")
    return movableIcon
end

----------------------------------------------------
-- TELEGRAM POPUP (WORKING)
----------------------------------------------------
local function CreateTelegramPopup()
    print("ðŸ“± Creating Telegram popup...")
    
    Storage.popupShown = true
    SaveSettings()
    
    -- Create overlay
    local overlay = Instance.new("Frame", gui)
    overlay.Name = "PopupOverlay"
    overlay.Size = UDim2.new(1, 0, 1, 0)
    overlay.BackgroundColor3 = Color3.fromRGB(0, 0, 0)
    overlay.BackgroundTransparency = 0.5
    overlay.ZIndex = 10
    
    -- Popup
    local popup = Instance.new("Frame", overlay)
    popup.Name = "TelegramPopup"
    popup.Size = UDim2.new(0, 400, 0, 300)
    popup.Position = UDim2.new(0.5, 0, 0.5, 0)
    popup.AnchorPoint = Vector2.new(0.5, 0.5)
    popup.BackgroundColor3 = Color3.fromRGB(20, 20, 30)
    popup.ZIndex = 11
    
    local corner = Instance.new("UICorner", popup)
    corner.CornerRadius = UDim.new(0, 20)
    
    -- Title
    local title = Instance.new("TextLabel", popup)
    title.Size = UDim2.new(1, -40, 0, 60)
    title.Position = UDim2.new(0, 20, 0, 10)
    title.Text = "Join Our Telegram"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 24
    title.TextColor3 = Color3.fromRGB(255, 255, 255)
    title.BackgroundTransparency = 1
    
    -- Description
    local desc = Instance.new("TextLabel", popup)
    desc.Size = UDim2.new(1, -40, 0, 80)
    desc.Position = UDim2.new(0, 20, 0, 80)
    desc.Text = "Get daily scripts, tutorials, and exclusive content!"
    desc.Font = Enum.Font.Gotham
    desc.TextSize = 16
    desc.TextColor3 = Color3.fromRGB(200, 200, 220)
    desc.BackgroundTransparency = 1
    desc.TextWrapped = true
    
    -- Telegram button
    local tgButton = Instance.new("TextButton", popup)
    tgButton.Size = UDim2.new(1, -40, 0, 50)
    tgButton.Position = UDim2.new(0, 20, 0, 180)
    tgButton.Text = "Join Telegram Group"
    tgButton.Font = Enum.Font.GothamBold
    tgButton.TextSize = 18
    tgButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    tgButton.BackgroundColor3 = Color3.fromRGB(34, 158, 217)
    
    local tgCorner = Instance.new("UICorner", tgButton)
    tgCorner.CornerRadius = UDim.new(0, 12)
    
    -- Continue button
    local continueButton = Instance.new("TextButton", popup)
    continueButton.Size = UDim2.new(1, -40, 0, 40)
    continueButton.Position = UDim2.new(0, 20, 0, 240)
    continueButton.Text = "Continue Without Joining"
    continueButton.Font = Enum.Font.Gotham
    continueButton.TextSize = 14
    continueButton.TextColor3 = Color3.fromRGB(180, 180, 200)
    continueButton.BackgroundColor3 = Color3.fromRGB(40, 40, 50)
    
    local continueCorner = Instance.new("UICorner", continueButton)
    continueCorner.CornerRadius = UDim.new(0, 10)
    
    -- Animate in
    popup.Size = UDim2.new(0, 0, 0, 0)
    popup:TweenSize(UDim2.new(0, 400, 0, 300), "Out", "Back", 0.5, true)
    
    -- Button handlers
    tgButton.MouseButton1Click:Connect(function()
        Storage.telegramClicked = true
        SaveSettings()
        
        -- Open Telegram link
        local url = "https://t.me/RBLX_SCRIPTS_MYANMAR"
        pcall(function()
            if setclipboard then
                setclipboard(url)
                tgButton.Text = "Link Copied!"
                task.wait(1)
                tgButton.Text = "Join Telegram Group"
            end
        end)
        
        -- Open in browser if possible
        pcall(function()
            if request then
                request({
                    Url = "http://localhost:6463/rpc?v=1",
                    Method = "POST",
                    Headers = {
                        ["Content-Type"] = "application/json"
                    },
                    Body = HttpService:JSONEncode({
                        cmd = "INVITE_BROWSER",
                        args = {code = url},
                        nonce = HttpService:GenerateGUID(false)
                    })
                })
            end
        end)
        
        -- Close popup
        popup:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
        task.wait(0.4)
        overlay:Destroy()
        
        -- Open main GUI
        CreateMainGUI()
    end)
    
    continueButton.MouseButton1Click:Connect(function()
        Storage.telegramClicked = false
        SaveSettings()
        
        -- Close popup
        popup:TweenSize(UDim2.new(0, 0, 0, 0), "In", "Back", 0.4, true)
        task.wait(0.4)
        overlay:Destroy()
        
        -- Open main GUI
        CreateMainGUI()
    end)
    
    print("âœ… Telegram popup created")
end

----------------------------------------------------
-- MAIN GUI (FIXED - GUARANTEED TO WORK)
----------------------------------------------------
local shaderEffects = {}
local fpsCounterActive = false

local function CreateMainGUI()
    print("ðŸ–¥ï¸ Creating main GUI...")
    
    -- Close existing GUI
    if gui:FindFirstChild("MainGUI") then
        gui:FindFirstChild("MainGUI"):Destroy()
    end
    
    -- Create main frame
    local mainFrame = Instance.new("Frame", gui)
    mainFrame.Name = "MainGUI"
    mainFrame.Size = UDim2.new(0, 350, 0, 400)
    mainFrame.AnchorPoint = Vector2.new(0.5, 0.5)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 35)
    mainFrame.Active = true
    mainFrame.Draggable = true
    
    -- Set position
    local screenSize = workspace.CurrentCamera.ViewportSize
    mainFrame.Position = UDim2.new(
        Storage.windowPosition.X or 0.5,
        (Storage.windowPosition.X or 0.5) * screenSize.X,
        Storage.windowPosition.Y or 0.5,
        (Storage.windowPosition.Y or 0.5) * screenSize.Y
    )
    
    -- Style
    local corner = Instance.new("UICorner", mainFrame)
    corner.CornerRadius = UDim.new(0, 20)
    
    local stroke = Instance.new("UIStroke", mainFrame)
    stroke.Color = Color3.fromRGB(60, 60, 80)
    stroke.Thickness = 2
    
    -- Title bar
    local titleBar = Instance.new("Frame", mainFrame)
    titleBar.Size = UDim2.new(1, 0, 0, 40)
    titleBar.BackgroundColor3 = Color3.fromRGB(35, 35, 45)
    titleBar.BorderSizePixel = 0
    
    local titleCorner = Instance.new("UICorner", titleBar)
    titleCorner.CornerRadius = UDim.new(0, 20, 0, 0)
    
    local title = Instance.new("TextLabel", titleBar)
    title.Size = UDim2.new(1, -40, 1, 0)
    title.Position = UDim2.new(0, 10, 0, 0)
    title.Text = "Ultra Enhancer"
    title.Font = Enum.Font.GothamBold
    title.TextSize = 18
    title.TextColor3 = Color3.fromRGB(220, 220, 255)
    title.BackgroundTransparency = 1
    title.TextXAlignment = Enum.TextXAlignment.Left
    
    -- Close button
    local closeBtn = Instance.new("TextButton", titleBar)
    closeBtn.Size = UDim2.new(0, 30, 0, 30)
    closeBtn.Position = UDim2.new(1, -35, 0.5, -15)
    closeBtn.Text = "Ã—"
    closeBtn.Font = Enum.Font.GothamBold
    closeBtn.TextSize = 24
    closeBtn.TextColor3 = Color3.fromRGB(255, 100, 100)
    closeBtn.BackgroundTransparency = 1
    
    closeBtn.MouseButton1Click:Connect(function()
        -- Save position
        local screenSize = workspace.CurrentCamera.ViewportSize
        Storage.windowPosition = {
            X = mainFrame.Position.X.Offset / screenSize.X,
            Y = mainFrame.Position.Y.Offset / screenSize.Y
        }
        SaveSettings()
        
        -- Close animation
        TweenService:Create(mainFrame, TweenInfo.new(0.3), {
            Size = UDim2.new(0, 0, 0, 0),
            Position = UDim2.new(0.5, 0, 0.5, 0)
        }):Play()
        task.wait(0.3)
        mainFrame:Destroy()
    end)
    
    -- Content area
    local content = Instance.new("Frame", mainFrame)
    content.Size = UDim2.new(1, -20, 1, -60)
    content.Position = UDim2.new(0, 10, 0, 50)
    content.BackgroundTransparency = 1
    
    -- 1. SHADER TOGGLE BUTTON
    local shaderBtn = Instance.new("TextButton", content)
    shaderBtn.Name = "ShaderButton"
    shaderBtn.Size = UDim2.new(1, 0, 0, 50)
    shaderBtn.Position = UDim2.new(0, 0, 0, 0)
    shaderBtn.Text = Storage.shaderEnabled and "Disable Shader" or "Enable Shader"
    shaderBtn.Font = Enum.Font.GothamSemibold
    shaderBtn.TextSize = 16
    shaderBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    shaderBtn.BackgroundColor3 = Storage.shaderEnabled and Color3.fromRGB(60, 100, 180) or Color3.fromRGB(40, 40, 60)
    
    local shaderCorner = Instance.new("UICorner", shaderBtn)
    shaderCorner.CornerRadius = UDim.new(0, 12)
    
    local shaderStroke = Instance.new("UIStroke", shaderBtn)
    shaderStroke.Color = Color3.fromRGB(80, 120, 255)
    shaderStroke.Thickness = 2
    
    -- 2. FPS BOOST BUTTON
    local fpsBtn = Instance.new("TextButton", content)
    fpsBtn.Name = "FPSButton"
    fpsBtn.Size = UDim2.new(1, 0, 0, 50)
    fpsBtn.Position = UDim2.new(0, 0, 0, 60)
    fpsBtn.Text = "Optimize Performance"
    fpsBtn.Font = Enum.Font.GothamSemibold
    fpsBtn.TextSize = 16
    fpsBtn.TextColor3 = Color3.fromRGB(255, 255, 255)
    fpsBtn.BackgroundColor3 = Color3.fromRGB(50, 60, 80)
    
    local fpsCorner = Instance.new("UICorner", fpsBtn)
    fpsCorner.CornerRadius = UDim.new(0, 12)
    
    local fpsStroke = Instance.new("UIStroke", fpsBtn)
    fpsStroke.Color = Color3.fromRGB(100, 200, 100)
    fpsStroke.Thickness = 2
    
    -- 3. FPS COUNTER
    local fpsLabel = Instance.new("TextLabel", content)
    fpsLabel.Name = "FPSLabel"
    fpsLabel.Size = UDim2.new(1, 0, 0, 40)
    fpsLabel.Position = UDim2.new(0, 0, 0, 120)
    fpsLabel.Text = "FPS: --"
    fpsLabel.Font = Enum.Font.GothamSemibold
    fpsLabel.TextSize = 20
    fpsLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
    fpsLabel.BackgroundTransparency = 1
    fpsLabel.TextXAlignment = Enum.TextXAlignment.Center
    
    -- 4. VOLUME SLIDER
    local volumeContainer = Instance.new("Frame", content)
    volumeContainer.Size = UDim2.new(1, 0, 0, 60)
    volumeContainer.Position = UDim2.new(0, 0, 0, 170)
    volumeContainer.BackgroundTransparency = 1
    
    local volumeLabel = Instance.new("TextLabel", volumeContainer)
    volumeLabel.Size = UDim2.new(1, 0, 0, 20)
    volumeLabel.Text = "Volume: " .. math.floor(Storage.volume * 100) .. "%"
    volumeLabel.Font = Enum.Font.Gotham
    volumeLabel.TextSize = 14
    volumeLabel.TextColor3 = Color3.fromRGB(200, 200, 220)
    volumeLabel.BackgroundTransparency = 1
    volumeLabel.TextXAlignment = Enum.TextXAlignment.Left
    
    local volumeSlider = Instance.new("Frame", volumeContainer)
    volumeSlider.Size = UDim2.new(1, 0, 0, 10)
    volumeSlider.Position = UDim2.new(0, 0, 0, 30)
    volumeSlider.BackgroundColor3 = Color3.fromRGB(50, 50, 70)
    
    local sliderCorner = Instance.new("UICorner", volumeSlider)
    sliderCorner.CornerRadius = UDim.new(1, 0)
    
    local volumeFill = Instance.new("Frame", volumeSlider)
    volumeFill.Size = UDim2.new(Storage.volume, 0, 1, 0)
    volumeFill.BackgroundColor3 = Color3.fromRGB(100, 150, 255)
    volumeFill.BorderSizePixel = 0
    
    local fillCorner = Instance.new("UICorner", volumeFill)
    fillCorner.CornerRadius = UDim.new(1, 0)
    
    -- Volume slider interaction
    volumeSlider.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            local mousePos = UserInputService:GetMouseLocation()
            local sliderPos = volumeSlider.AbsolutePosition
            local sliderSize = volumeSlider.AbsoluteSize
            local relativeX = (mousePos.X - sliderPos.X) / sliderSize.X
            relativeX = math.clamp(relativeX, 0, 1)
            
            Storage.volume = relativeX
            volumeFill.Size = UDim2.new(relativeX, 0, 1, 0)
            volumeLabel.Text = "Volume: " .. math.floor(relativeX * 100) .. "%"
            SaveSettings()
        end
    end)
    
    -- 5. RESET BUTTON
    local resetBtn = Instance.new("TextButton", content)
    resetBtn.Size = UDim2.new(1, 0, 0, 40)
    resetBtn.Position = UDim2.new(0, 0, 0, 240)
    resetBtn.Text = "Reset Settings"
    resetBtn.Font = Enum.Font.Gotham
    resetBtn.TextSize = 14
    resetBtn.TextColor3 = Color3.fromRGB(255, 150, 150)
    resetBtn.BackgroundColor3 = Color3.fromRGB(60, 40, 40)
    
    local resetCorner = Instance.new("UICorner", resetBtn)
    resetCorner.CornerRadius = UDim.new(0, 10)
    
    -- Animate in
    mainFrame.Size = UDim2.new(0, 0, 0, 0)
    mainFrame:TweenSize(UDim2.new(0, 350, 0, 400), "Out", "Back", 0.5, true)
    
    -- Save position on drag end
    mainFrame.DragStopped:Connect(function()
        local screenSize = workspace.CurrentCamera.ViewportSize
        Storage.windowPosition = {
            X = mainFrame.Position.X.Offset / screenSize.X,
            Y = mainFrame.Position.Y.Offset / screenSize.Y
        }
        SaveSettings()
    end)
    
    -- ========== FUNCTIONALITY ==========
    
    -- SHADER TOGGLE
    shaderBtn.MouseButton1Click:Connect(function()
        Storage.shaderEnabled = not Storage.shaderEnabled
        SaveSettings()
        
        if Storage.shaderEnabled then
            -- Enable shader
            shaderBtn.Text = "Disable Shader"
            TweenService:Create(shaderBtn, TweenInfo.new(0.3), {
                BackgroundColor3 = Color3.fromRGB(60, 100, 180)
            }):Play()
            
            -- Apply enhanced shader
            Lighting.Ambient = Color3.fromRGB(25, 28, 35)
            Lighting.Brightness = 1.8
            Lighting.GlobalShadows = true
            Lighting.ShadowSoftness = 0.08
            Lighting.ClockTime = 14
            
            -- Create effects
            local bloom = Instance.new("BloomEffect", Lighting)
            bloom.Intensity = 0.25
            bloom.Size = 32
            bloom.Threshold = 0.9
            table.insert(shaderEffects, bloom)
            
            local colorCorrection = Instance.new("ColorCorrectionEffect", Lighting)
            colorCorrection.Brightness = 0.05
            colorCorrection.Contrast = 0.35
            colorCorrection.Saturation = 0.1
            table.insert(shaderEffects, colorCorrection)
            
            NotificationManager:Show("Shader Enabled", "Ultra graphics activated", 2)
        else
            -- Disable shader
            shaderBtn.Text = "Enable Shader"
            TweenService:Create(shaderBtn, TweenInfo.new(0.3), {
                BackgroundColor3 = Color3.fromRGB(40, 40, 60)
            }):Play()
            
            -- Remove effects
            for _, effect in ipairs(shaderEffects) do
                if effect then
                    effect:Destroy()
                end
            end
            shaderEffects = {}
            
            -- Reset lighting
            Lighting.Ambient = Color3.fromRGB(127, 127, 127)
            Lighting.Brightness = 1
            
            NotificationManager:Show("Shader Disabled", "Graphics reset to default", 2)
        end
    end)
    
    -- FPS BOOST
    fpsBtn.MouseButton1Click:Connect(function()
        -- Optimize game
        for _, obj in pairs(workspace:GetDescendants()) do
            if obj:IsA("BasePart") then
                obj.Material = Enum.Material.SmoothPlastic
            elseif obj:IsA("ParticleEmitter") or obj:IsA("Trail") then
                obj.Enabled = false
            end
        end
        
        settings().Rendering.QualityLevel = 1
        Lighting.GlobalShadows = true
        Lighting.FogEnd = 100000
        
        fpsBtn.Text = "Optimized!"
        TweenService:Create(fpsBtn, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(30, 150, 60)
        }):Play()
        
        task.wait(1.5)
        
        fpsBtn.Text = "Optimize Performance"
        TweenService:Create(fpsBtn, TweenInfo.new(0.3), {
            BackgroundColor3 = Color3.fromRGB(50, 60, 80)
        }):Play()
        
        NotificationManager:Show("Performance Boosted", "Game optimized for maximum FPS", 3)
    end)
    
    -- FPS COUNTER
    fpsCounterActive = true
    local lastUpdate = tick()
    local frameCount = 0
    
    local fpsUpdate = RunService.RenderStepped:Connect(function()
        if not fpsCounterActive then
            fpsUpdate:Disconnect()
            return
        end
        
        frameCount = frameCount + 1
        local currentTime = tick()
        
        if currentTime - lastUpdate >= 1 then
            local fps = frameCount
            frameCount = 0
            lastUpdate = currentTime
            
            fpsLabel.Text = "FPS: " .. tostring(fps)
            
            -- Color coding
            if fps >= 60 then
                fpsLabel.TextColor3 = Color3.fromRGB(100, 255, 150)
            elseif fps >= 30 then
                fpsLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
            else
                fpsLabel.TextColor3 = Color3.fromRGB(255, 100, 100)
            end
        end
    end)
    
    -- RESET SETTINGS
    resetBtn.MouseButton1Click:Connect(function()
        -- Reset storage
        Storage = {
            popupShown = true, -- Don't show popup again
            telegramClicked = false,
            shaderEnabled = false,
            iconPosition = {X = 0.03, Y = 0.03},
            windowPosition = {X = 0.5, Y = 0.5},
            volume = 0.5
        }
        SaveSettings()
        
        -- Reset shader if active
        if #shaderEffects > 0 then
            for _, effect in ipairs(shaderEffects) do
                if effect then
                    effect:Destroy()
                end
            end
            shaderEffects = {}
            Lighting.Ambient = Color3.fromRGB(127, 127, 127)
            Lighting.Brightness = 1
        end
        
        NotificationManager:Show("Settings Reset", "All settings have been reset", 3)
        
        -- Update UI
        shaderBtn.Text = "Enable Shader"
        shaderBtn.BackgroundColor3 = Color3.fromRGB(40, 40, 60)
        volumeFill.Size = UDim2.new(0.5, 0, 1, 0)
        volumeLabel.Text = "Volume: 50%"
    end)
    
    -- Cleanup when GUI closes
    mainFrame.Destroying:Once(function()
        fpsCounterActive = false
    end)
    
    print("âœ… Main GUI created successfully")
    return mainFrame
end

----------------------------------------------------
-- INITIALIZATION (GUARANTEED TO WORK)
----------------------------------------------------
print("ðŸš€ Starting Ultra Enhancer...")

-- Load settings first
LoadSettings()

-- Create icon (always works)
CreateIcon()

-- Show welcome notification
task.wait(1)
NotificationManager:Show("Ultra Enhancer", "Successfully loaded! Click the icon.", 3)

-- Auto-open GUI if this is first time
if not Storage.popupShown then
    print("ðŸ”„ First time setup - showing popup")
    task.wait(2)
    CreateTelegramPopup()
elseif Storage.telegramClicked then
    print("ðŸ”„ Auto-opening main GUI")
    task.wait(2)
    CreateMainGUI()
end

-- Auto-save on game close
game:BindToClose(function()
    SaveSettings()
    print("ðŸ’¾ Settings saved before closing")
end)

print("âœ… Ultra Enhancer fully loaded and ready!")
print("ðŸ“Š Stats:")
print("   Popup shown:", Storage.popupShown)
print("   Telegram clicked:", Storage.telegramClicked)
print("   Shader enabled:", Storage.shaderEnabled)

-- Final confirmation
task.wait(3)
if movableIcon and movableIcon.Parent then
    NotificationManager:Show("Ready!", "Click the blue icon to open menu", 4)
end